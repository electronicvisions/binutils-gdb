#!/usr/bin/env groovy
@Library("jenlib") _

node {
	try {
		cleanWs()

		stage('Checkout') {
			inSingularity() {
				withWaf() {
					try {
						sish "waf setup " +
						     "--project binutils-gdb@binutils-2_25-branch-nux " +
						     "--clone-depth 1 " +
						     "--gerrit-changes=${GERRIT_CHANGE_NUMBER} " +
						     "--gerrit-url=ssh://hudson@$GERRIT_HOST:$GERRIT_PORT"
					} catch (MissingPropertyException ignored) {     // Jenkinsfile not called via Gerrit
						sish "waf setup " +
						     "--project binutils-gdb@binutils-2_25-branch-nux " +
						     "--clone-depth 1"
					}
				}
			}
		}

		stage("Build") {
			onSlurmResource(partition: "jenkins", "cpus-per-task": "8") {
				inSingularity(app: "visionary-dls") {
					sish "bash binutils-gdb/ci/00_build_install.sh"
				}
			}
		}

	} catch (Exception e) {
		post_error_build_action()
		throw e as java.lang.Throwable
	} finally {
		post_all_build_action()
	}

	// Some Jenkins steps fail a build without raising (e.g. archiveArtifacts)
	if (currentBuild.currentResult != "SUCCESS") {
		post_error_build_action()
	}
}

/*
/* HELPER FUNCTIONS
*/

void post_all_build_action() {
	// Always clean the workspace
	cleanWs()
}

void post_error_build_action() {
	notifyFailure(mattermostChannel: "#dls-software")
}
